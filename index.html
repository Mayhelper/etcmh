// Глобальная переменная для хранения данных из Excel
let adaptationData = {};
let teamsData = {};

// URL шаблона
const TEMPLATE_URL = 'https://raw.githubusercontent.com/Mayhelper/mayhelper/main/planadapt.xlsx';

// DOM элементы
const employeeNameInput = document.getElementById('employeeName');
const teamSelect = document.getElementById('team');
const positionSelect = document.getElementById('position');
const managerInput = document.getElementById('manager');
const mentorInput = document.getElementById('mentor');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const adaptationPeriodInput = document.getElementById('adaptationPeriod');
const employeeSignatureInput = document.getElementById('employeeSignature');
const managerSignatureInput = document.getElementById('managerSignature');
const mentorSignatureInput = document.getElementById('mentorSignature');
const orientationHint = document.getElementById('orientationHint');
const statusText = document.getElementById('statusText');
const statusIcon = document.getElementById('statusIcon');
const saveStatus = document.getElementById('saveStatus');
const exportBtn = document.getElementById('exportBtn');
const downloadContainer = document.getElementById('downloadContainer');
const statTeams = document.getElementById('statTeams');
const statPositions = document.getElementById('statPositions');
const statTeamsBadge = document.getElementById('statTeamsBadge');
const statPositionsBadge = document.getElementById('statPositionsBadge');
const fileUploadBlock = document.getElementById('fileUploadBlock');

// Таблицы - инициализируются после загрузки DOM
let mandatoryTrainingTable;
let additionalTrainingTable;
let meetingsTable;
let tasksTable;
let kpiTable;

// Кнопки добавления
let addMandatoryTaskBtn;
let addAdditionalTaskBtn;
let addMeetingBtn;
let addTaskBtn;
let addKpiBtn;

// Флаг для отслеживания инициализации обработчика positionSelect
let positionSelectHandlerInitialized = false;

// Функция инициализации таблиц
function initTables() {
    try {
        const mandatoryTraining = document.getElementById('mandatoryTraining');
        const additionalTraining = document.getElementById('additionalTraining');
        const meetings = document.getElementById('meetings');
        const tasks = document.getElementById('tasks');
        const kpi = document.getElementById('kpi');
        
        if (mandatoryTraining) {
            mandatoryTrainingTable = mandatoryTraining.getElementsByTagName('tbody')[0];
        }
        if (additionalTraining) {
            additionalTrainingTable = additionalTraining.getElementsByTagName('tbody')[0];
        }
        if (meetings) {
            meetingsTable = meetings.getElementsByTagName('tbody')[0];
        }
        if (tasks) {
            tasksTable = tasks.getElementsByTagName('tbody')[0];
        }
        if (kpi) {
            kpiTable = kpi.getElementsByTagName('tbody')[0];
        }
        
        addMandatoryTaskBtn = document.getElementById('addMandatoryTask');
        addAdditionalTaskBtn = document.getElementById('addAdditionalTask');
        addMeetingBtn = document.getElementById('addMeeting');
        addTaskBtn = document.getElementById('addTask');
        addKpiBtn = document.getElementById('addKpi');
        
        // Устанавливаем обработчики событий для кнопок добавления
        if (addMandatoryTaskBtn && mandatoryTrainingTable) {
            addMandatoryTaskBtn.addEventListener('click', () => addTaskRow(mandatoryTrainingTable, '', true));
        }
        if (addAdditionalTaskBtn && additionalTrainingTable) {
            addAdditionalTaskBtn.addEventListener('click', () => addTaskRow(additionalTrainingTable, '', true));
        }
        if (addMeetingBtn && meetingsTable) {
            addMeetingBtn.addEventListener('click', () => addTaskRow(meetingsTable, '', true));
        }
        if (addTaskBtn && tasksTable) {
            addTaskBtn.addEventListener('click', () => addTaskRow(tasksTable, '', true));
        }
        if (addKpiBtn && kpiTable) {
            addKpiBtn.addEventListener('click', () => addKpiRow('', '', true));
        }
        
        // Устанавливаем обработчик для выбора должности после инициализации таблиц (только один раз)
        if (positionSelect && !positionSelectHandlerInitialized) {
            positionSelect.addEventListener('change', loadPositionData);
            positionSelectHandlerInitialized = true;
            console.log('Обработчик для positionSelect установлен');
        }
    } catch (error) {
        console.error('Ошибка при инициализации таблиц:', error);
    }
}

// Функция для проверки ориентации
function checkOrientation() {
    const isPortrait = window.innerHeight > window.innerWidth;
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && isPortrait) {
        orientationHint.classList.add('show');
    } else {
        orientationHint.classList.remove('show');
    }
}

// Функция обновления статуса сохранения
function updateSaveStatus(type, message) {
    saveStatus.textContent = message;
    saveStatus.className = 'save-status show ' + type;
    
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            saveStatus.classList.remove('show');
        }, 5000);
    }
}

// Обновление списка должностей при выборе команды
function updatePositionsByTeam(selectedTeam) {
    // Очищаем список и добавляем опцию по умолчанию безопасным способом
    positionSelect.textContent = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Выберите должность';
    positionSelect.appendChild(defaultOption);
    
    if (!selectedTeam) {
        positionSelect.disabled = true;
        return;
    }
    
    const positions = teamsData[selectedTeam];
    
    if (positions && positions.length > 0) {
        positionSelect.disabled = false;
        
        positions.forEach(position => {
            const option = document.createElement('option');
            option.value = position.name;
            option.textContent = position.name;
            positionSelect.appendChild(option);
        });
    } else {
        positionSelect.disabled = true;
        positionSelect.textContent = '';
        const noOption = document.createElement('option');
        noOption.value = '';
        noOption.textContent = 'Нет должностей для этой команды';
        positionSelect.appendChild(noOption);
    }
}

// Загрузка файла с сервера
async function loadFileFromServer() {
    try {
        updateFileStatus('info', 'Загрузка шаблона адаптации...');
        hideFileStats();
        
        const response = await fetch(TEMPLATE_URL);
        
        if (!response.ok) {
            throw new Error(`Ошибка загрузки: ${response.status} ${response.statusText}`);
        }
        
        updateFileStatus('info', 'Обработка данных...');
        
        const arrayBuffer = await response.arrayBuffer();
        
        adaptationData = {};
        teamsData = {};
        
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        
        updateFileStatus('info', 'Парсинг данных...');
        
        // Обрабатываем лист "Роли"
        if (workbook.Sheets["Роли"]) {
            const rolesSheet = XLSX.utils.sheet_to_json(workbook.Sheets["Роли"], { header: 1 });
            
            for (let i = 1; i < rolesSheet.length; i++) {
                const row = rolesSheet[i];
                if (row && row.length >= 3) {
                    const position = row[0];
                    const team = row[1];
                    const period = row[2];
                    
                    if (position && team) {
                        adaptationData[position] = {
                            team: team,
                            period: period,
                            mandatoryTraining: [],
                            additionalTraining: [],
                            meetings: [],
                            tasks: [],
                            kpi: []
                        };
                        
                        if (!teamsData[team]) {
                            teamsData[team] = [];
                        }
                        teamsData[team].push({
                            name: position,
                            period: period
                        });
                    }
                }
            }
            
            // Заполняем выпадающий список команд
            if (teamSelect) {
                teamSelect.textContent = '';
                const defaultTeamOption = document.createElement('option');
                defaultTeamOption.value = '';
                defaultTeamOption.textContent = 'Выберите команду';
                teamSelect.appendChild(defaultTeamOption);
                
                for (const team in teamsData) {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamSelect.appendChild(option);
                }
            }
        }
        
        // Обрабатываем данные для каждой должности
        let processedPositions = 0;
        const totalPositions = Object.keys(adaptationData).length;
        
        for (const position in adaptationData) {
            if (workbook.Sheets[position]) {
                const positionSheet = XLSX.utils.sheet_to_json(workbook.Sheets[position], { header: 1 });
                parsePositionData(position, positionSheet);
                processedPositions++;
                
                if (processedPositions % 5 === 0 || processedPositions === totalPositions) {
                    updateFileStatus('info', `Обработка должностей... ${processedPositions}/${totalPositions}`);
                }
            }
        }
        
        const teamCount = Object.keys(teamsData).length;
        const positionCount = processedPositions;
        updateFileStatus('success', 'Шаблон успешно загружен');
        
        // Обновляем статистику
        updateFileStats(teamCount, positionCount);
        
    } catch (error) {
        console.error('Ошибка при загрузке файла:', error);
        console.error('Тип ошибки:', error.name);
        console.error('Сообщение:', error.message);
        console.error('Стек:', error.stack);
        
        let errorMessage = 'Ошибка при загрузке шаблона';
        
        // Более детальная обработка ошибок
        if (error.message && error.message.includes('404')) {
            errorMessage = 'Ошибка: Файл шаблона не найден на сервере (404)';
        } else if (error.message && (error.message.includes('network') || error.message.includes('fetch') || error.message.includes('Failed to fetch') || error.message.includes('CORS'))) {
            errorMessage = 'Ошибка: Проблема с сетевым подключением или CORS';
        } else if (error.message && error.message.includes('XLSX')) {
            errorMessage = 'Ошибка: Не удалось прочитать файл Excel';
        } else if (error.message) {
            errorMessage = `Ошибка: ${error.message}`;
        } else {
            errorMessage = 'Ошибка: Неизвестная ошибка при загрузке';
        }
        
        updateFileStatus('error', errorMessage);
        hideFileStats();
    }
}

// Обновление статуса загрузки файла
function updateFileStatus(type, message, details = '') {
    if (statusText) {
        statusText.textContent = message;
    }
    
    // Обновляем иконку в зависимости от статуса
    if (statusIcon) {
        statusIcon.className = 'status-icon';
        switch(type) {
            case 'info':
                statusIcon.textContent = '⏳';
                break;
            case 'success':
                statusIcon.textContent = '✅';
                statusIcon.classList.add('success');
                break;
            case 'error':
                statusIcon.textContent = '❌';
                statusIcon.classList.add('error');
                break;
            case 'warning':
                statusIcon.textContent = '⚠️';
                break;
        }
    }
}

// Обновление статистики файла
function updateFileStats(teamCount, positionCount) {
    if (statTeams) {
        statTeams.textContent = teamCount;
    }
    if (statPositions) {
        statPositions.textContent = positionCount;
    }
    
    // Показываем бейджи со статистикой
    if (statTeamsBadge && teamCount > 0) {
        statTeamsBadge.style.display = 'inline-flex';
    }
    if (statPositionsBadge && positionCount > 0) {
        statPositionsBadge.style.display = 'inline-flex';
    }
}

// Скрытие статистики
function hideFileStats() {
    if (statTeamsBadge) {
        statTeamsBadge.style.display = 'none';
    }
    if (statPositionsBadge) {
        statPositionsBadge.style.display = 'none';
    }
}

// Обработчики событий
teamSelect.addEventListener('change', function() {
    updatePositionsByTeam(this.value);
    positionSelect.value = '';
    clearAllTables();
});

// Обработчик для positionSelect устанавливается в initTables() после инициализации таблиц
if (startDateInput) {
    startDateInput.addEventListener('change', calculateAdaptationPeriod);
}
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);

// Автоматическое заполнение подписей
if (employeeNameInput) {
    employeeNameInput.addEventListener('input', updateSignatures);
}
if (managerInput) {
    managerInput.addEventListener('input', updateSignatures);
}
if (mentorInput) {
    mentorInput.addEventListener('input', updateSignatures);
}

// Обработчики для кнопок добавления теперь устанавливаются в initTables()

// Кнопка обновления удалена - теперь обновление происходит автоматически при загрузке страницы

// Кнопка скрытия блока удалена - блок теперь всегда видим

// Обновление подписей
function updateSignatures() {
    employeeSignatureInput.value = employeeNameInput.value || '';
    managerSignatureInput.value = managerInput.value || '';
    mentorSignatureInput.value = mentorInput.value || '';
}

function parsePositionData(position, sheetData) {
    let currentSection = '';
    let sectionCounts = {
        mandatoryTraining: 0,
        additionalTraining: 0,
        meetings: 0,
        tasks: 0,
        kpi: 0
    };
    
    console.log(`Парсинг данных для должности: ${position}, строк: ${sheetData.length}`);
    
    for (let i = 0; i < sheetData.length; i++) {
        const row = sheetData[i];
        if (!row || row.length === 0) continue;
        
        const firstCell = row[0];
        
        if (typeof firstCell === 'string') {
            if (firstCell.includes('Курс ориентации - Обязательное обучение')) {
                currentSection = 'mandatoryTraining';
                console.log(`Найдена секция: ${currentSection}`);
            } else if (firstCell.includes('Курс ориентации - Дополнительное обучение')) {
                currentSection = 'additionalTraining';
                console.log(`Найдена секция: ${currentSection}`);
            } else if (firstCell.includes('Обязательные встречи')) {
                currentSection = 'meetings';
                console.log(`Найдена секция: ${currentSection}`);
            } else if (firstCell.includes('Задачи')) {
                currentSection = 'tasks';
                console.log(`Найдена секция: ${currentSection}`);
            } else if (firstCell.includes('КПР')) {
                currentSection = 'kpi';
                console.log(`Найдена секция: ${currentSection}`);
            }
            else if (firstCell === 'Название курса/тренинга' || 
                     firstCell === 'Встреча' || 
                     firstCell === 'Задача' ||
                     firstCell === 'Наименование') {
                continue;
            }
            else if (currentSection && firstCell && firstCell.trim() !== '') {
                if (currentSection === 'kpi') {
                    if (row.length >= 2) {
                        adaptationData[position][currentSection].push({
                            name: firstCell,
                            weight: row[1] || ''
                        });
                        sectionCounts.kpi++;
                    }
                } else {
                    adaptationData[position][currentSection].push(firstCell);
                    sectionCounts[currentSection]++;
                }
            }
        }
    }
    
    console.log(`Данные для ${position}:`, sectionCounts);
    console.log(`Полные данные:`, adaptationData[position]);
}

function loadPositionData() {
    console.log('loadPositionData вызвана');
    
    if (!positionSelect) {
        console.error('positionSelect не определен');
        return;
    }
    
    if (!positionSelect.value) {
        console.log('positionSelect.value пусто');
        return;
    }
    
    const position = positionSelect.value;
    console.log('Выбранная должность:', position);
    
    if (!adaptationData[position]) {
        console.error('Нет данных для должности:', position);
        console.log('Доступные должности:', Object.keys(adaptationData));
        return;
    }
    
    const data = adaptationData[position];
    console.log('Данные для должности:', data);
    
    clearAllTables();
    
    // Проверяем, что таблицы инициализированы
    if (!mandatoryTrainingTable || !additionalTrainingTable || !meetingsTable || !tasksTable || !kpiTable) {
        console.warn('Таблицы не инициализированы, пытаемся инициализировать...');
        initTables();
    }
    
    if (data.mandatoryTraining && mandatoryTrainingTable) {
        console.log('Добавляем обязательное обучение:', data.mandatoryTraining.length, 'задач');
        data.mandatoryTraining.forEach(task => {
            addTaskRow(mandatoryTrainingTable, task, false);
        });
    } else {
        console.log('Нет данных обязательного обучения или таблица не инициализирована');
    }
    
    if (data.additionalTraining && additionalTrainingTable) {
        console.log('Добавляем дополнительное обучение:', data.additionalTraining.length, 'задач');
        data.additionalTraining.forEach(task => {
            addTaskRow(additionalTrainingTable, task, false);
        });
    } else {
        console.log('Нет данных дополнительного обучения или таблица не инициализирована');
    }
    
    if (data.meetings && meetingsTable) {
        console.log('Добавляем встречи:', data.meetings.length, 'встреч');
        data.meetings.forEach(meeting => {
            addTaskRow(meetingsTable, meeting, false);
        });
    } else {
        console.log('Нет данных встреч или таблица не инициализирована');
    }
    
    if (data.tasks && tasksTable) {
        console.log('Добавляем задачи:', data.tasks.length, 'задач');
        data.tasks.forEach(task => {
            addTaskRow(tasksTable, task, false);
        });
    } else {
        console.log('Нет данных задач или таблица не инициализирована');
    }
    
    if (data.kpi && kpiTable) {
        console.log('Добавляем KPI:', data.kpi.length, 'KPI');
        data.kpi.forEach(kpi => {
            addKpiRow(kpi.name, kpi.weight, false);
        });
    } else {
        console.log('Нет данных KPI или таблица не инициализирована');
    }
    
    console.log('loadPositionData завершена');
}

function addTaskRow(table, taskName, isNew) {
    const row = table.insertRow();
    
    const taskCell = row.insertCell(0);
    if (taskName) {
        taskCell.textContent = taskName;
    } else {
        const taskInput = document.createElement('input');
        taskInput.type = 'text';
        taskInput.placeholder = 'Введите задачу';
        taskCell.appendChild(taskInput);
    }
    
    // Устанавливаем текущую дату по умолчанию для поля "Дата план"
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    const planDateCell = row.insertCell(1);
    const planDateInput = document.createElement('input');
    planDateInput.type = 'date';
    planDateInput.placeholder = 'Выберите дату';
    planDateInput.value = todayStr;
    planDateCell.appendChild(planDateInput);
    
    const factDateCell = row.insertCell(2);
    const factDateInput = document.createElement('input');
    factDateInput.type = 'date';
    factDateInput.placeholder = 'Выберите дату';
    factDateCell.appendChild(factDateInput);
    
    const completionCell = row.insertCell(3);
    const completionSelect = document.createElement('select');
    const option1 = document.createElement('option');
    option1.value = '';
    option1.textContent = 'Выберите статус';
    completionSelect.appendChild(option1);
    const option2 = document.createElement('option');
    option2.value = '+';
    option2.textContent = '+';
    completionSelect.appendChild(option2);
    const option3 = document.createElement('option');
    option3.value = '-';
    option3.textContent = '-';
    completionSelect.appendChild(option3);
    completionCell.appendChild(completionSelect);
    
    const mentorCell = row.insertCell(4);
    const mentorInput = document.createElement('input');
    mentorInput.type = 'text';
    mentorInput.placeholder = 'Введите комментарий';
    mentorCell.appendChild(mentorInput);
    
    const actionsCell = row.insertCell(5);
    if (isNew) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-small';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.addEventListener('click', function() {
            table.deleteRow(row.rowIndex - 1);
        });
        actionsCell.appendChild(deleteBtn);
    }
}

function addKpiRow(name = '', weight = '', isNew) {
    if (!kpiTable) {
        console.error('Таблица KPI не инициализирована');
        return;
    }
    const row = kpiTable.insertRow();
    
    const nameCell = row.insertCell(0);
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = name || '';
    nameInput.placeholder = 'Введите КПР';
    nameCell.appendChild(nameInput);
    
    const weightCell = row.insertCell(1);
    const weightInput = document.createElement('input');
    weightInput.type = 'text';
    weightInput.value = weight || '';
    weightInput.placeholder = 'Введите вес';
    weightCell.appendChild(weightInput);
    
    const planCell = row.insertCell(2);
    const planInput = document.createElement('input');
    planInput.type = 'text';
    planInput.placeholder = 'Введите план';
    planCell.appendChild(planInput);
    
    const factCell = row.insertCell(3);
    const factInput = document.createElement('input');
    factInput.type = 'text';
    factInput.placeholder = 'Введите факт';
    factCell.appendChild(factInput);
    
    const percentCell = row.insertCell(4);
    const percentInput = document.createElement('input');
    percentInput.type = 'text';
    percentInput.readOnly = true;
    percentInput.placeholder = '%';
    percentCell.appendChild(percentInput);
    
    const actionsCell = row.insertCell(5);
    if (isNew) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-small';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.addEventListener('click', function() {
            kpiTable.deleteRow(row.rowIndex - 1);
        });
        actionsCell.appendChild(deleteBtn);
    }
    
    function calculatePercentage() {
        const plan = parseFloat(planInput.value) || 0;
        const fact = parseFloat(factInput.value) || 0;
        
        if (plan > 0) {
            const percentage = (fact / plan) * 100;
            percentInput.value = percentage.toFixed(2) + '%';
        } else {
            percentInput.value = '';
        }
    }
    
    planInput.addEventListener('input', calculatePercentage);
    factInput.addEventListener('input', calculatePercentage);
}

function clearTable(table) {
    if (table) {
        while (table.rows.length > 0) {
            table.deleteRow(0);
        }
    }
}

function clearAllTables() {
    if (mandatoryTrainingTable) clearTable(mandatoryTrainingTable);
    if (additionalTrainingTable) clearTable(additionalTrainingTable);
    if (meetingsTable) clearTable(meetingsTable);
    if (tasksTable) clearTable(tasksTable);
    if (kpiTable) clearTable(kpiTable);
}

function calculateAdaptationPeriod() {
    const startDate = new Date(startDateInput.value);
    if (isNaN(startDate.getTime())) return;
    
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + 3);
    
    const formatDate = (date) => {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    };
    
    endDateInput.value = endDate.toISOString().split('T')[0];
    adaptationPeriodInput.value = `${formatDate(startDate)} - ${formatDate(endDate)}`;
}

// Функция для преобразования ArrayBuffer в Base64
function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

// Функция для получения всех данных формы в JSON
function getAllFormData() {
    const formData = {
        // Основная информация
        employeeName: document.getElementById('employeeName').value,
        team: document.getElementById('team').value,
        position: document.getElementById('position').value,
        manager: document.getElementById('manager').value,
        mentor: document.getElementById('mentor').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        adaptationPeriod: document.getElementById('adaptationPeriod').value,
        
        // Данные таблиц
        mandatoryTraining: getTableData(mandatoryTrainingTable),
        additionalTraining: getTableData(additionalTrainingTable),
        meetings: getTableData(meetingsTable),
        tasks: getTableData(tasksTable),
        kpi: getKPIData(kpiTable),
        
        // Комментарии и подписи
        assessmentDate: document.getElementById('assessmentDate').value,
        managerComments: document.getElementById('managerComments').value,
        mentorComments: document.getElementById('mentorComments').value,
        hrComments: document.getElementById('hrComments').value,
        employeeAssessment: document.getElementById('employeeAssessment').value,
        employeeSignature: document.getElementById('employeeSignature').value,
        managerSignature: document.getElementById('managerSignature').value,
        mentorSignature: document.getElementById('mentorSignature').value,
        hrSignature: document.getElementById('hrSignature').value,
        
        // Метаданные
        exportTimestamp: new Date().toISOString(),
        version: '1.0'
    };
    
    return formData;
}

// Функция для получения данных из таблицы
function getTableData(table) {
    const rows = table.getElementsByTagName('tr');
    const data = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Пропускаем строку, если это заголовок или пустая строка
        if (cells.length < 5) continue;
        
        const rowData = {
            action: getCellValue(cells[0]),
            planDate: getCellValue(cells[1]),
            factDate: getCellValue(cells[2]),
            completion: getCellValue(cells[3]),
            comment: getCellValue(cells[4])
        };
        
        data.push(rowData);
    }
    
    return data;
}

// Функция для получения данных KPI
function getKPIData(table) {
    const rows = table.getElementsByTagName('tr');
    const data = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        if (cells.length < 5) continue;
        
        const rowData = {
            name: getCellValue(cells[0]),
            weight: getCellValue(cells[1]),
            plan: getCellValue(cells[2]),
            fact: getCellValue(cells[3]),
            percent: getCellValue(cells[4])
        };
        
        data.push(rowData);
    }
    
    return data;
}

// Вспомогательная функция для получения значения ячейки
function getCellValue(cell) {
    const input = cell.querySelector('input, select, textarea');
    if (input) {
        return input.value;
    }
    return cell.textContent.trim();
}

// Проверка, находимся ли мы в Cordova InAppBrowser
function isCordovaInAppBrowser() {
    return navigator.userAgent.includes('Crosswalk') || 
           (navigator.userAgent.includes('Android') && navigator.userAgent.includes('Version')) ||
           /inappbrowser/i.test(navigator.userAgent) ||
           window.cordova !== undefined;
}

// Функция выгрузки данных в Excel
async function exportToExcel() {
    try {
        updateSaveStatus('processing', 'Создание Excel файла...');
        
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('План адаптации');

        // Стили
        const titleStyle = {
            font: { bold: true, size: 18, color: { argb: 'FFFFFFFF' } },
            alignment: { horizontal: 'center', vertical: 'middle' },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } },
            border: {
                top: { style: 'medium', color: { argb: 'FF2C3E50' } },
                left: { style: 'medium', color: { argb: 'FF2C3E50' } },
                bottom: { style: 'medium', color: { argb: 'FF2C3E50' } },
                right: { style: 'medium', color: { argb: 'FF2C3E50' } }
            }
        };

        const sectionHeaderStyle = {
            font: { bold: true, size: 14, color: { argb: 'FFFFFFFF' } },
            alignment: { horizontal: 'center', vertical: 'middle' },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3498DB' } },
            border: {
                top: { style: 'medium', color: { argb: 'FF2980B9' } },
                left: { style: 'medium', color: { argb: 'FF2980B9' } },
                bottom: { style: 'medium', color: { argb: 'FF2980B9' } },
                right: { style: 'medium', color: { argb: 'FF2980B9' } }
            }
        };

        const subsectionHeaderStyle = {
            font: { bold: true, size: 12, color: { argb: 'FFFFFFFF' } },
            alignment: { horizontal: 'center', vertical: 'middle' },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF5D6D7E' } },
            border: {
                top: { style: 'thin', color: { argb: 'FF2C3E50' } },
                left: { style: 'thin', color: { argb: 'FF2C3E50' } },
                bottom: { style: 'thin', color: { argb: 'FF2C3E50' } },
                right: { style: 'thin', color: { argb: 'FF2C3E50' } }
            }
        };

        const tableHeaderStyle = {
            font: { bold: true, color: { argb: 'FFFFFFFF' } },
            alignment: { horizontal: 'center', vertical: 'middle' },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF34495E' } },
            border: {
                top: { style: 'thin', color: { argb: 'FF2C3E50' } },
                left: { style: 'thin', color: { argb: 'FF2C3E50' } },
                bottom: { style: 'thin', color: { argb: 'FF2C3E50' } },
                right: { style: 'thin', color: { argb: 'FF2C3E50' } }
            }
        };

        const labelStyle = {
            font: { bold: true },
            alignment: { vertical: 'middle' },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FA' } },
            border: {
                top: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                left: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                bottom: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                right: { style: 'thin', color: { argb: 'FFBDC3C7' } }
            }
        };

        const valueStyle = {
            alignment: { vertical: 'middle' },
            border: {
                top: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                left: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                bottom: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                right: { style: 'thin', color: { argb: 'FFBDC3C7' } }
            }
        };

        const dataStyle = {
            alignment: { vertical: 'middle' },
            border: {
                top: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                left: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                bottom: { style: 'thin', color: { argb: 'FFBDC3C7' } },
                right: { style: 'thin', color: { argb: 'FFBDC3C7' } }
            }
        };

        let currentRow = 1;

        // === ЗАГОЛОВОК ===
        const titleRow = worksheet.getRow(currentRow);
        titleRow.getCell(1).value = 'ПЛАН АДАПТАЦИИ СОТРУДНИКА';
        titleRow.getCell(1).style = titleStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        // === ОСНОВНАЯ ИНФОРМАЦИЯ ===
        const mainInfoHeader = worksheet.getRow(currentRow);
        mainInfoHeader.getCell(1).value = 'ОСНОВНАЯ ИНФОРМАЦИЯ';
        mainInfoHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const mainInfoData = [
            ['Фамилия Имя Отчество', document.getElementById('employeeName').value || ''],
            ['Должность', document.getElementById('position').value || ''],
            ['Команда/Сообщество', document.getElementById('team').value || ''],
            ['Период адаптации', document.getElementById('adaptationPeriod').value || ''],
            ['Руководитель', document.getElementById('manager').value || ''],
            ['Наставник', document.getElementById('mentor').value || ''],
            ['Дата начала адаптации', document.getElementById('startDate').value || ''],
            ['Дата окончания адаптации', document.getElementById('endDate').value || '']
        ];

        mainInfoData.forEach(([label, value]) => {
            const row = worksheet.getRow(currentRow);
            row.getCell(1).value = label;
            row.getCell(1).style = labelStyle;
            
            row.getCell(2).value = value;
            worksheet.mergeCells(`B${currentRow}:E${currentRow}`);
            row.getCell(2).style = valueStyle;
            currentRow++;
        });

        // === 1. КУРС ОРИЕНТАЦИИ ===
        const orientationHeader = worksheet.getRow(currentRow);
        orientationHeader.getCell(1).value = '1. КУРС ОРИЕНТАЦИИ';
        orientationHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        // Обязательное обучение
        const mandatoryHeader = worksheet.getRow(currentRow);
        mandatoryHeader.getCell(1).value = 'ОБЯЗАТЕЛЬНОЕ ОБУЧЕНИЕ';
        mandatoryHeader.getCell(1).style = subsectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const mandatoryTableHeaders = ['Действия', 'Дата план', 'Дата факт', 'Отметка о выполнении', 'Комментарий/Наставник'];
        const mandatoryHeaderRow = worksheet.getRow(currentRow);
        mandatoryTableHeaders.forEach((header, index) => {
            mandatoryHeaderRow.getCell(index + 1).value = header;
            mandatoryHeaderRow.getCell(index + 1).style = tableHeaderStyle;
        });
        currentRow++;

        const mandatoryRows = mandatoryTrainingTable.getElementsByTagName('tr');
        for (let i = 0; i < mandatoryRows.length; i++) {
            const row = mandatoryRows[i];
            const cells = row.getElementsByTagName('td');
            const dataRow = worksheet.getRow(currentRow);
            
            for (let j = 0; j < cells.length - 1; j++) {
                const cell = cells[j];
                const input = cell.querySelector('input, select');
                if (input) {
                    dataRow.getCell(j + 1).value = input.value;
                } else {
                    dataRow.getCell(j + 1).value = cell.textContent;
                }
                dataRow.getCell(j + 1).style = dataStyle;
            }
            currentRow++;
        }

        // Дополнительное обучение
        const additionalHeader = worksheet.getRow(currentRow);
        additionalHeader.getCell(1).value = 'ДОПОЛНИТЕЛЬНОЕ ОБУЧЕНИЕ';
        additionalHeader.getCell(1).style = subsectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const additionalHeaderRow = worksheet.getRow(currentRow);
        mandatoryTableHeaders.forEach((header, index) => {
            additionalHeaderRow.getCell(index + 1).value = header;
            additionalHeaderRow.getCell(index + 1).style = tableHeaderStyle;
        });
        currentRow++;

        const additionalRows = additionalTrainingTable.getElementsByTagName('tr');
        for (let i = 0; i < additionalRows.length; i++) {
            const row = additionalRows[i];
            const cells = row.getElementsByTagName('td');
            const dataRow = worksheet.getRow(currentRow);
            
            for (let j = 0; j < cells.length - 1; j++) {
                const cell = cells[j];
                const input = cell.querySelector('input, select');
                if (input) {
                    dataRow.getCell(j + 1).value = input.value;
                } else {
                    dataRow.getCell(j + 1).value = cell.textContent;
                }
                dataRow.getCell(j + 1).style = dataStyle;
            }
            currentRow++;
        }

        // === 2. ОБЯЗАТЕЛЬНЫЕ ВСТРЕЧИ ===
        const meetingsHeader = worksheet.getRow(currentRow);
        meetingsHeader.getCell(1).value = '2. ОБЯЗАТЕЛЬНЫЕ ВСТРЕЧИ';
        meetingsHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const meetingsTableHeaders = ['Встречи по процессу', 'Дата план', 'Дата факт', 'Отметка о выполнении', 'Комментарий/Наставник'];
        const meetingsHeaderRow = worksheet.getRow(currentRow);
        meetingsTableHeaders.forEach((header, index) => {
            meetingsHeaderRow.getCell(index + 1).value = header;
            meetingsHeaderRow.getCell(index + 1).style = tableHeaderStyle;
        });
        currentRow++;

        const meetingRows = meetingsTable.getElementsByTagName('tr');
        for (let i = 0; i < meetingRows.length; i++) {
            const row = meetingRows[i];
            const cells = row.getElementsByTagName('td');
            const dataRow = worksheet.getRow(currentRow);
            
            for (let j = 0; j < cells.length - 1; j++) {
                const cell = cells[j];
                const input = cell.querySelector('input, select');
                if (input) {
                    dataRow.getCell(j + 1).value = input.value;
                } else {
                    dataRow.getCell(j + 1).value = cell.textContent;
                }
                dataRow.getCell(j + 1).style = dataStyle;
            }
            currentRow++;
        }

        // === 3. ЗАДАЧИ ===
        const tasksHeader = worksheet.getRow(currentRow);
        tasksHeader.getCell(1).value = '3. ЗАДАЧИ';
        tasksHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const tasksTableHeaders = ['Действия', 'Дата план', 'Дата факт', 'Отметка о выполнении', 'Комментарий/Наставник'];
        const tasksHeaderRow = worksheet.getRow(currentRow);
        tasksTableHeaders.forEach((header, index) => {
            tasksHeaderRow.getCell(index + 1).value = header;
            tasksHeaderRow.getCell(index + 1).style = tableHeaderStyle;
        });
        currentRow++;

        const taskRows = tasksTable.getElementsByTagName('tr');
        for (let i = 0; i < taskRows.length; i++) {
            const row = taskRows[i];
            const cells = row.getElementsByTagName('td');
            const dataRow = worksheet.getRow(currentRow);
            
            for (let j = 0; j < cells.length - 1; j++) {
                const cell = cells[j];
                const input = cell.querySelector('input, select');
                if (input) {
                    dataRow.getCell(j + 1).value = input.value;
                } else {
                    dataRow.getCell(j + 1).value = cell.textContent;
                }
                dataRow.getCell(j + 1).style = dataStyle;
            }
            currentRow++;
        }

        // === 4. КПР ===
        const kpiHeader = worksheet.getRow(currentRow);
        kpiHeader.getCell(1).value = '4. КПР';
        kpiHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const kpiTableHeaders = ['Наименование', 'Вес', 'План', 'Факт', '% выполнения'];
        const kpiHeaderRow = worksheet.getRow(currentRow);
        kpiTableHeaders.forEach((header, index) => {
            kpiHeaderRow.getCell(index + 1).value = header;
            kpiHeaderRow.getCell(index + 1).style = tableHeaderStyle;
        });
        currentRow++;

        const kpiRows = kpiTable.getElementsByTagName('tr');
        for (let i = 0; i < kpiRows.length; i++) {
            const row = kpiRows[i];
            const cells = row.getElementsByTagName('td');
            const dataRow = worksheet.getRow(currentRow);
            
            for (let j = 0; j < cells.length - 1; j++) {
                const cell = cells[j];
                const input = cell.querySelector('input');
                if (input) {
                    dataRow.getCell(j + 1).value = input.value;
                } else {
                    dataRow.getCell(j + 1).value = cell.textContent;
                }
                dataRow.getCell(j + 1).style = dataStyle;
            }
            currentRow++;
        }

        // === ЗАКЛЮЧЕНИЕ ===
        const conclusionHeader = worksheet.getRow(currentRow);
        conclusionHeader.getCell(1).value = 'ЗАКЛЮЧЕНИЕ РУКОВОДИТЕЛЯ ПО ИТОГАМ ПЕРИОДА АДАПТАЦИИ СОТРУДНИКА';
        conclusionHeader.getCell(1).style = sectionHeaderStyle;
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        // Дата проведения оценки
        const assessmentDateRow = worksheet.getRow(currentRow);
        assessmentDateRow.getCell(1).value = 'Дата проведения оценки';
        assessmentDateRow.getCell(1).style = labelStyle;
        assessmentDateRow.getCell(2).value = document.getElementById('assessmentDate').value || '';
        worksheet.mergeCells(`B${currentRow}:E${currentRow}`);
        assessmentDateRow.getCell(2).style = valueStyle;
        currentRow++;

        // Комментарии руководителя
        const managerCommentsHeader = worksheet.getRow(currentRow);
        managerCommentsHeader.getCell(1).value = 'Комментарии руководителя:';
        managerCommentsHeader.getCell(1).style = { ...labelStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F6F3' } } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const managerCommentsRow = worksheet.getRow(currentRow);
        managerCommentsRow.getCell(1).value = document.getElementById('managerComments').value || '_________________________________________________________________________________________';
        managerCommentsRow.getCell(1).style = { ...valueStyle, alignment: { wrapText: true } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        managerCommentsRow.height = 60;
        currentRow++;

        // Комментарии наставника
        const mentorCommentsHeader = worksheet.getRow(currentRow);
        mentorCommentsHeader.getCell(1).value = 'Комментарии наставника:';
        mentorCommentsHeader.getCell(1).style = { ...labelStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F6F3' } } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const mentorCommentsRow = worksheet.getRow(currentRow);
        mentorCommentsRow.getCell(1).value = document.getElementById('mentorComments').value || '_________________________________________________________________________________________';
        mentorCommentsRow.getCell(1).style = { ...valueStyle, alignment: { wrapText: true } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        mentorCommentsRow.height = 60;
        currentRow++;

        // Комментарии HR
        const hrCommentsHeader = worksheet.getRow(currentRow);
        hrCommentsHeader.getCell(1).value = 'Комментарии HR:';
        hrCommentsHeader.getCell(1).style = { ...labelStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F6F3' } } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const hrCommentsRow = worksheet.getRow(currentRow);
        hrCommentsRow.getCell(1).value = document.getElementById('hrComments').value || '_________________________________________________________________________________________';
        hrCommentsRow.getCell(1).style = { ...valueStyle, alignment: { wrapText: true } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        hrCommentsRow.height = 60;
        currentRow++;

        // Оценка сотрудника
        const employeeAssessmentHeader = worksheet.getRow(currentRow);
        employeeAssessmentHeader.getCell(1).value = 'Оценка сотрудником периода вхождения в должность:';
        employeeAssessmentHeader.getCell(1).style = { ...labelStyle, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F6F3' } } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const employeeAssessmentRow = worksheet.getRow(currentRow);
        employeeAssessmentRow.getCell(1).value = document.getElementById('employeeAssessment').value || '_________________________________________________________________________________________';
        employeeAssessmentRow.getCell(1).style = { ...valueStyle, alignment: { wrapText: true } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        employeeAssessmentRow.height = 60;
        currentRow++;

        // ПОДПИСИ
        const signaturesHeader = worksheet.getRow(currentRow);
        signaturesHeader.getCell(1).value = 'ПОДПИСИ:';
        signaturesHeader.getCell(1).style = { ...labelStyle, font: { bold: true, size: 12 } };
        worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
        currentRow++;

        const signaturesData = [
            ['Сотрудник', document.getElementById('employeeSignature').value || '__________________________'],
            ['Руководитель', document.getElementById('managerSignature').value || '__________________________'],
            ['Наставник', document.getElementById('mentorSignature').value || '__________________________'],
            ['HR бизнес-партнер', document.getElementById('hrSignature').value || '__________________________']
        ];

        signaturesData.forEach(([label, value]) => {
            const row = worksheet.getRow(currentRow);
            row.getCell(1).value = label;
            row.getCell(1).style = labelStyle;
            row.getCell(2).value = value;
            worksheet.mergeCells(`B${currentRow}:E${currentRow}`);
            row.getCell(2).style = valueStyle;
            currentRow++;
        });

        // Настраиваем ширину колонок
        worksheet.columns = [
            { width: 40 },
            { width: 15 },
            { width: 15 },
            { width: 20 },
            { width: 20 }
        ];

        // Настраиваем высоту строк
        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber === 1) {
                row.height = 30;
            } else if ([2, 11, 12 + mandatoryRows.length + additionalRows.length, 13 + mandatoryRows.length + additionalRows.length + meetingRows.length, 14 + mandatoryRows.length + additionalRows.length + meetingRows.length + taskRows.length, 15 + mandatoryRows.length + additionalRows.length + meetingRows.length + taskRows.length + kpiRows.length].includes(rowNumber)) {
                row.height = 25;
            } else if ([12, 13 + mandatoryRows.length].includes(rowNumber)) {
                row.height = 20;
            }
        });

        worksheet.properties.defaultRowHeight = 20;

        // Генерируем буфер
        const buffer = await workbook.xlsx.writeBuffer();
        const employeeName = document.getElementById('employeeName').value || 'сотрудник';
        const position = document.getElementById('position').value || 'должность';
        
        // Очищаем имя файла от недопустимых символов
        const safeEmployeeName = (employeeName || 'сотрудник').replace(/[<>:"/\\|?*]/g, '_');
        const safePosition = (position || 'должность').replace(/[<>:"/\\|?*]/g, '_');
        const fileName = `План адаптации - ${safeEmployeeName} - ${safePosition}.xlsx`;
        
        // Проверяем, находимся ли мы в Cordova InAppBrowser
        if (isCordovaInAppBrowser()) {
            // РЕЖИМ CORDOVA - ПЕРЕДАЕМ ДАННЫЕ ЧЕРЕЗ URL
            
            // Преобразуем буфер в Base64
            const base64Data = arrayBufferToBase64(buffer);
            
            // Получаем все данные формы в JSON
            const jsonData = getAllFormData();
            const jsonString = JSON.stringify(jsonData);
            
            // Кодируем данные для URL
            const fileNameEncoded = encodeURIComponent(fileName);
            const jsonDataEncoded = encodeURIComponent(jsonString);
            
            // Проверяем размер данных
            const base64Size = base64Data.length;
            const maxSize = 10000; // Максимальный размер для передачи через URL
            
            if (base64Size < maxSize) {
                // Если данные небольшие, передаем base64
                const base64DataEncoded = encodeURIComponent(base64Data);
                const redirectUrl = `cordova-file-ready://export?action=save&type=excel&filename=${fileNameEncoded}&data=${base64DataEncoded}&json=${jsonDataEncoded}&employee=${encodeURIComponent(employeeName)}&position=${encodeURIComponent(position)}`;
                
                // Делаем переход по URL
                window.location.href = redirectUrl;
                
                updateSaveStatus('success', 'Файл передан в приложение');
            } else {
                // Если данные слишком большие, передаем только JSON
                const redirectUrl = `cordova-file-ready://export?action=save&type=json&filename=${fileNameEncoded}&json=${jsonDataEncoded}&employee=${encodeURIComponent(employeeName)}&position=${encodeURIComponent(position)}&size=${base64Size}`;
                
                // Делаем переход по URL
                window.location.href = redirectUrl;
                
                updateSaveStatus('success', 'Данные переданы в приложение. Файл будет создан автоматически.');
            }
            
            // Показываем сообщение для пользователя
            setTimeout(() => {
                updateSaveStatus('info', 'Если приложение не отреагировало, убедитесь, что оно имеет доступ к файлам');
            }, 2000);
            
        } else {
            // РЕЖИМ БРАУЗЕРА - СКАЧИВАЕМ ФАЙЛ
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([buffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            const url = URL.createObjectURL(blob);
            
            // Создаем ссылку и автоматически кликаем по ней
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Освобождаем память через 1 минуту
            setTimeout(() => URL.revokeObjectURL(url), 60000);
            
            // Показываем кнопку для повторного скачивания
            showDownloadButton(fileName);
            
            updateSaveStatus('success', `Файл "${fileName}" скачан успешно!`);
        }
        
    } catch (error) {
        console.error('Ошибка при выгрузке в Excel:', error);
        updateSaveStatus('error', `Ошибка при создании Excel файла: ${error.message}`);
    }
}

// Функция для экранирования HTML (дополнительная защита)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Функция для создания кнопки скачивания
function showDownloadButton(fileName) {
    const downloadContainer = document.getElementById('downloadContainer');
    downloadContainer.textContent = '';
    
    const downloadBox = document.createElement('div');
    downloadBox.className = 'download-box';
    
    const safeFileName = fileName || 'План адаптации.xlsx';
    
    // Создаем заголовок
    const h3 = document.createElement('h3');
    h3.textContent = '✅ Файл готов!';
    downloadBox.appendChild(h3);
    
    // Создаем параграф с именем файла
    const p = document.createElement('p');
    const strong = document.createElement('strong');
    strong.textContent = safeFileName;    p.appendChild(document.createTextNode('Файл '));
    p.appendChild(strong);
    p.appendChild(document.createTextNode(' скачан автоматически.'));
    downloadBox.appendChild(p);
    
    // Создаем инструкции
    const instructionsDiv = document.createElement('div');
    instructionsDiv.className = 'instructions';
    
    const strongInst = document.createElement('strong');
    strongInst.textContent = 'Если файл не скачался:';
    instructionsDiv.appendChild(strongInst);
    instructionsDiv.appendChild(document.createElement('br'));
    
    instructionsDiv.appendChild(document.createTextNode('1. Нажмите на кнопку ниже'));
    instructionsDiv.appendChild(document.createElement('br'));
    instructionsDiv.appendChild(document.createTextNode('2. Если файл открывается в браузере:'));
    instructionsDiv.appendChild(document.createElement('br'));
    
    const androidText = document.createTextNode('   - На Android: нажмите три точки → "Скачать"');
    instructionsDiv.appendChild(androidText);
    instructionsDiv.appendChild(document.createElement('br'));
    
    const iosText = document.createTextNode('   - На iOS: нажмите "Поделиться" → "Сохранить в файлы"');
    instructionsDiv.appendChild(iosText);
    instructionsDiv.appendChild(document.createElement('br'));
    
    instructionsDiv.appendChild(document.createTextNode('3. Сохраните файл в нужную папку'));
    downloadBox.appendChild(instructionsDiv);
    
    // Создаем кнопку
    const downloadBtn = document.createElement('button');
    downloadBtn.id = 'manualDownloadBtn';
    downloadBtn.className = 'download-button';
    downloadBtn.textContent = '⬇️ Скачать еще раз';
    downloadBtn.addEventListener('click', exportToExcel);
    downloadBox.appendChild(downloadBtn);
    
    downloadContainer.appendChild(downloadBox);
    downloadContainer.classList.add('show');
}

// Обработчик для кнопки экспорта
if (exportBtn) {
    exportBtn.addEventListener('click', exportToExcel);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Сначала инициализируем таблицы
        initTables();
        
        const today = new Date();
        if (startDateInput) {
            startDateInput.value = today.toISOString().split('T')[0];
            calculateAdaptationPeriod();
        }
        
        checkOrientation();
        
        // Небольшая задержка для полной инициализации DOM
        setTimeout(() => {
            loadFileFromServer();
        }, 100);
    } catch (error) {
        console.error('Ошибка при инициализации:', error);
        console.error('Детали:', error.message, error.stack);
        if (statusText) {
            statusText.textContent = 'Ошибка инициализации страницы: ' + error.message;
        }
        if (statusIcon) {
            statusIcon.textContent = '❌';
            statusIcon.classList.add('error');
        }
    }
});

