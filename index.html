<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä MML –æ—Ç—á–µ—Ç–æ–≤ - –§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–ª–∏–≤–∫–µ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
            font-size: 0.95em;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px dashed #3498db;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #2980b9;
            background: #f0f7ff;
        }

        .file-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-label {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
            font-weight: 500;
        }

        .file-label:hover {
            background: #2980b9;
        }

        .file-name {
            color: #2c3e50;
            font-style: italic;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            flex-grow: 1;
            min-width: 200px;
        }

        input[type="file"] {
            display: none;
        }

        .search-section {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeaea;
        }

        .search-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex-grow: 1;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            min-width: 300px;
            text-transform: uppercase;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #27ae60;
        }

        .search-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }

        .results-title {
            font-size: 1.5em;
            color: #2c3e50;
        }

        .results-count {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .tt-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .info-item {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #eaeaea;
            margin-bottom: 6px;
        }

        .info-label {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 500;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .info-value {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9em;
            text-align: right;
            word-break: break-word;
        }

        .filter-options-container {
            margin-bottom: 20px;
            padding: 0;
        }

        .sku-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .sku-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .sku-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .sku-table tr {
            border-bottom: 1px solid #eaeaea;
            transition: background 0.2s;
        }

        .sku-table tr:hover {
            background: #f8f9fa;
        }

        .sku-table td {
            padding: 12px 15px;
        }

        .sku-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .sku-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-green-fill {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-no-fill {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-green-fill .status-icon {
            background: #28a745;
        }

        .status-no-fill .status-icon {
            background: #dc3545;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .no-results-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .error-message {
            background: #ffeaea;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #e74c3c;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #3498db;
        }

        .loading.completed {
            display: block;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .progress-bar-container {
            width: 33.33%;
            max-width: 300px;
            margin: 15px auto 5px auto;
            background-color: #f3f3f3;
            border-radius: 8px;
            overflow: hidden;
            height: 20px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-bar-percent {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 600;
            font-size: 0.75em;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            width: 100%;
            text-align: center;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 20px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.85em;
            z-index: 1;
            pointer-events: none;
        }

        .progress-label {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .load-date-info {
            text-align: center;
            color: #27ae60;
            font-size: 0.85em;
            margin-top: 10px;
            font-weight: 500;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            margin-top: 10px;
            transition: background 0.3s;
            display: inline-block;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .loading.completed {
            padding: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-options .results-count {
            margin-left: auto;
            margin-bottom: 0;
        }

        .filter-options .results-count {
            margin-left: auto;
            margin-bottom: 0;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ß–ê–ô/–ö–û–§–ï */
        .category-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .category-tab {
            padding: 12px 40px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
        }

        .category-tab.active[data-category="tea"] {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .category-tab.active[data-category="coffee"] {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        .category-tab[data-category="tea"]:hover:not(.active) {
            background: #e8f4f8;
            border-color: #3498db;
        }

        .category-tab[data-category="coffee"]:hover:not(.active) {
            background: #e8f8f0;
            border-color: #2ecc71;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .file-input-wrapper,
            .search-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input,
            .file-name {
                min-width: unset;
                width: 100%;
            }
            
            h1 {
                font-size: 1.8em;
            }

            .tt-info {
                padding: 12px;
                margin-bottom: 15px;
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 6px 10px;
                margin-bottom: 4px;
            }

            .info-label {
                font-size: 0.8em;
                margin-bottom: 2px;
                margin-right: 0;
            }

            .info-value {
                font-size: 0.85em;
                text-align: left;
            }

            .filter-options-container {
                margin-bottom: 15px;
            }

            .filter-options {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                width: 100%;
            }

            .filter-btn {
                flex: 1;
                min-width: 120px;
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .filter-options .results-count {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                text-align: center;
            }

            .results-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .results-count {
                align-self: flex-end;
            }

            .sku-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sku-table {
                font-size: 0.85em;
                width: 100%;
                min-width: unset;
            }

            .sku-table th {
                padding: 8px 6px;
                font-size: 0.8em;
            }

            .sku-table td {
                padding: 8px 6px;
                font-size: 0.85em;
                word-wrap: break-word;
                word-break: break-word;
            }

            .sku-name {
                font-size: 0.85em;
                white-space: normal;
                word-wrap: break-word;
                word-break: break-word;
                line-height: 1.4;
            }

            .sku-status {
                font-size: 0.8em;
                padding: 4px 8px;
            }

            .status-icon {
                width: 8px;
                height: 8px;
            }

            .category-tabs {
                padding: 10px;
                gap: 8px;
            }
            
            .category-tab {
                flex: 1;
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–§–∞–∫—Ç –ø—Ä–æ–∫—É–ø–∫–∏ MML</h1>
        </header>

        <div class="search-section">
            <div class="search-input-wrapper">
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¢–¢ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –î–ú–ü-1003991)">
                <button id="searchBtn" class="search-btn" disabled>
                    –ù–∞–π—Ç–∏ –¢–¢
                </button>
            </div>
            <div id="errorMessage" class="error-message"></div>
            <div id="loading" class="loading">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">
                        <span class="progress-bar-percent" id="progressBarPercent">0%</span>
                    </div>
                    <div class="progress-text" id="progressText">–û—Å—Ç–∞–ª–æ—Å—å 100%</div>
                </div>
                <div class="progress-label">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                <div id="loadDateInfo" class="load-date-info" style="display: none;"></div>
                <div style="text-align: center; margin-top: 10px;">
                    <button id="refreshDataBtn" class="refresh-btn" style="display: none;">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h2 class="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ß–ê–ô –∏ –ö–û–§–ï -->
            <div class="category-tabs">
                <button class="category-tab active" data-category="tea">–ß–ê–ô</button>
                <button class="category-tab" data-category="coffee">–ö–û–§–ï</button>
            </div>

            <div class="tt-info">
                <div style="margin-bottom: 10px;">
                    <strong style="font-size: 1.1em;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–µ:</strong>
                </div>
                <div id="ttInfoContent">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="filter-options-container">
                <div class="filter-options">
                    <button class="filter-btn active" data-filter="mml">–ü–ª–∞–Ω MML</button>
                    <button class="filter-btn" data-filter="plus">–ü—Ä–æ–∫—É–ø–ª–µ–Ω–Ω—ã–µ MML</button>
                    <div class="results-count" id="resultsCount">0 SKU</div>
                </div>
            </div>

            <div class="sku-table-container">
                <table class="sku-table" id="skuTable">
                    <thead>
                        <tr>
                            <th style="width: 70%;">–ù–∞–∑–≤–∞–Ω–∏–µ SKU</th>
                            <th style="width: 15%;">–ü–ª–∞–Ω–æ–≤—ã–π MML</th>
                            <th style="width: 15%;">–ü—Ä–æ–∫—É–ø–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody id="skuTableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            <div class="no-results-icon">üîç</div>
            <p>–¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>
            <p style="font-size: 0.9em; margin-top: 10px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¢–¢</p>
        </div>

        <footer>
            <p>(c) –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –æ—Ç–¥–µ–ª–æ–º –û–†–ü–ü –≤ 2025–≥. –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –ú–ê–ô.</p>
        </footer>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ü–≤–µ—Ç–∞–º–∏ Excel -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        let workbook = null;
        let teaWorksheet = null;
        let coffeeWorksheet = null;
        let teaHeaders = [];
        let coffeeHeaders = [];
        let teaDataRows = [];
        let coffeeDataRows = [];
        let teaSkuStartIndex = null;
        let coffeeSkuStartIndex = null;
        let currentCategory = 'tea'; // 'tea' –∏–ª–∏ 'coffee'
        let currentFilter = 'mml';
        let currentRowData = null;
        let allSkuData = [];
        
        // –ö—ç—à –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∫–æ–ª–æ–Ω–æ–∫ (—É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫)
        const columnIndexCache = new Map();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function getActiveData() {
            if (currentCategory === 'tea') {
                return {
                    worksheet: teaWorksheet,
                    headers: teaHeaders,
                    dataRows: teaDataRows,
                    skuStartIndex: teaSkuStartIndex
                };
            } else {
                return {
                    worksheet: coffeeWorksheet,
                    headers: coffeeHeaders,
                    dataRows: coffeeDataRows,
                    skuStartIndex: coffeeSkuStartIndex
                };
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function setActiveData(worksheet, headers, dataRows, skuStartIndex) {
            if (currentCategory === 'tea') {
                teaWorksheet = worksheet;
                teaHeaders = headers;
                teaDataRows = dataRows;
                teaSkuStartIndex = skuStartIndex;
            } else {
                coffeeWorksheet = worksheet;
                coffeeHeaders = headers;
                coffeeDataRows = dataRows;
                coffeeSkuStartIndex = skuStartIndex;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ Title Case (–∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã)
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å–ª–æ–≤–∞
                if (!word) return word;
                // –ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ—á–Ω—ã–µ
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        // –ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—é—Ç—Å—è –¥–ª—è —á–∞—è/–∫–æ—Ñ–µ)
        function getInfoColumns() {
            const categoryLabel = currentCategory === 'tea' ? '–ß–∞–π' : '–ö–æ—Ñ–µ';
            const categoryLabelUpper = currentCategory === 'tea' ? '–ß–ê–ô' : '–ö–û–§–ï';
            
            return [
                { key: 'territoryCode', display: '–ö–æ–¥ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', search: ['–ö–æ–¥ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏'] },
                { key: 'tp', display: '–¢–ü', search: ['–¢–ü'] },
                { key: 'ttCode', display: '–ö–æ–¥ –¢–¢', search: ['–ö–æ–¥ –¢–¢'] },
                { key: 'ttName', display: '–ù–∞–∑–≤–∞–Ω–∏–µ –¢–¢', search: ['–ù–∞–∑–≤–∞–Ω–∏–µ –¢–¢'] },
                { key: 'address', display: '–ê–¥—Ä–µ—Å', search: ['–ê–¥—Ä–µ—Å'] },
                { key: 'ttType', display: '–¢–∏–ø –¢–¢', search: ['–¢–∏–ø –¢–¢'] },
                { key: 'ttChannel', display: '–ö–∞–Ω–∞–ª –¢–¢', search: ['–ö–∞–Ω–∞–ª –¢–¢', '–ö–∞–Ω–∞–ª', '–ö–∞–Ω–∞–ª<br>–¢–¢', '–ö–∞–Ω–∞–ª<br/>–¢–¢'] },
                { key: 'plan', display: `–ü–ª–∞–Ω MML ${categoryLabel}`, search: [`–ü–ª–∞–Ω MML ${categoryLabel}`, `–ü–ª–∞–Ω  MML ${categoryLabel}`] },
                { key: 'factQty', display: `–§–∞–∫—Ç MML ${categoryLabel} (–∫–æ–ª-–≤–æ)`, search: [`–§–∞–∫—Ç MML ${categoryLabel} (–∫–æ–ª-–≤–æ)`, `–§–∞–∫—Ç MML ${categoryLabel} <br>(–∫–æ–ª-–≤–æ)`, `–§–∞–∫—Ç MML ${categoryLabel}<br>(–∫–æ–ª-–≤–æ)`, `–§–∞–∫—Ç MML ${categoryLabel}`, '–∫–æ–ª-–≤–æ'] },
                { key: 'factPercent', display: `–§–∞–∫—Ç MML ${categoryLabel}%`, search: [`–§–∞–∫—Ç MML ${categoryLabel}%`, `–§–∞–∫—Ç MML ${categoryLabel} %`, `MML ${categoryLabel}%`] },
                { key: 'completion', display: `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MML ${categoryLabelUpper}`, search: [`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MML ${categoryLabelUpper}`, `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ<br>MML ${categoryLabelUpper}`, `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ<br/>MML ${categoryLabelUpper}`, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MML'] },
                { key: 'includeSDO', display: '–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç SDO', search: ['–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç SDO'] }
            ];
        }

        // URL —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö
        const DATA_FILE_URL = 'https://raw.githubusercontent.com/Mayhelper/mayhelper/main/datamml.xlsx';
        const CACHE_KEY = 'mml_data_cache';
        const CACHE_DATE_KEY = 'mml_cache_date';
        const CACHE_FILE_KEY = 'mml_file_cache';

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
        function getDateString(date = new Date()) {
            return date.toISOString().split('T')[0];
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ (–¥—Ä—É–≥–æ–π –¥–µ–Ω—å)
        function shouldRefreshCache() {
            try {
                const cachedDate = localStorage.getItem(CACHE_DATE_KEY);
                const today = getDateString();
                return !cachedDate || cachedDate !== today;
            } catch (e) {
                return true; // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–±–Ω–æ–≤–ª—è–µ–º
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        function saveToCache(fileArrayBuffer) {
            try {
                const today = getDateString();
                const loadTimestamp = new Date().toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–µ–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const cacheData = {
                    tea: {
                        headers: teaHeaders,
                        dataRows: teaDataRows,
                        skuStartIndex: teaSkuStartIndex
                    },
                    coffee: {
                        headers: coffeeHeaders,
                        dataRows: coffeeDataRows,
                        skuStartIndex: coffeeSkuStartIndex
                    },
                    loadDate: today,
                    loadTimestamp: loadTimestamp
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                localStorage.setItem(CACHE_DATE_KEY, today);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ workbook (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
                if (fileArrayBuffer) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º IndexedDB –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ base64
                    try {
                        const fileBlob = new Blob([fileArrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                        const reader = new FileReader();
                        reader.onload = function() {
                            try {
                                localStorage.setItem(CACHE_FILE_KEY, reader.result);
                            } catch (e) {
                                // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è localStorage, –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                                console.warn('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è');
                            }
                        };
                        reader.readAsDataURL(fileBlob);
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ –∫—ç—à:', e);
                    }
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à:', e);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞
        function getFromCache() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å
                if (shouldRefreshCache()) {
                    return null;
                }
                
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                return cacheData;
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        function getCachedFile() {
            try {
                if (shouldRefreshCache()) {
                    return null;
                }
                return localStorage.getItem(CACHE_FILE_KEY);
            } catch (e) {
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressBarPercent = document.getElementById('progressBarPercent');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            if (progressBarPercent) {
                progressBarPercent.textContent = Math.round(percent) + '%';
            }
            if (progressText) {
                const remaining = 100 - percent;
                progressText.textContent = text || `–û—Å—Ç–∞–ª–æ—Å—å ${remaining}%`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadFileFromServer() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                const loadDateInfo = document.getElementById('loadDateInfo');
                loadDateInfo.style.display = 'none';
                updateProgress(0, '–û—Å—Ç–∞–ª–æ—Å—å 100%');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                updateProgress(10, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞...');
                const cachedData = getFromCache();
                
                if (cachedData && !shouldRefreshCache()) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
                    if (cachedData.tea) {
                        teaHeaders = cachedData.tea.headers;
                        teaDataRows = cachedData.tea.dataRows;
                        teaSkuStartIndex = cachedData.tea.skuStartIndex;
                    }
                    if (cachedData.coffee) {
                        coffeeHeaders = cachedData.coffee.headers;
                        coffeeDataRows = cachedData.coffee.dataRows;
                        coffeeSkuStartIndex = cachedData.coffee.skuStartIndex;
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –¥–ª—è workbook (–Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª–µ–π)
                    updateProgress(30);
                    const cachedFile = getCachedFile();
                    let arrayBuffer;
                    
                    if (cachedFile) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                        const base64Data = cachedFile.includes(',') ? cachedFile.split(',')[1] : cachedFile;
                        const binaryString = atob(base64Data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        arrayBuffer = bytes.buffer;
                    } else {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —Å —Å–µ—Ä–≤–µ—Ä–∞
                        const response = await fetch(DATA_FILE_URL);
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${response.status} ${response.statusText}`);
                        }
                        arrayBuffer = await response.arrayBuffer();
                    }
                    
                    updateProgress(50);
                    const data = new Uint8Array(arrayBuffer);
                    workbook = XLSX.read(data, { 
                        type: 'array',
                        cellStyles: true
                    });
                    
                    // –ù–∞—Ö–æ–¥–∏–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —á–∞—è –∏ –∫–æ—Ñ–µ
                    const teaSheetName = 'MML —á–∞–π –±–µ–∑ –ü–ö';
                    const coffeeSheetName = 'MML –∫–æ—Ñ–µ';
                    
                    for (let i = 0; i < workbook.SheetNames.length; i++) {
                        const sheetName = workbook.SheetNames[i];
                        if (sheetName === teaSheetName || sheetName.includes('MML —á–∞–π –±–µ–∑ –ü–ö')) {
                            teaWorksheet = workbook.Sheets[sheetName];
                        }
                        if (sheetName === coffeeSheetName || sheetName.includes('MML –∫–æ—Ñ–µ')) {
                            coffeeWorksheet = workbook.Sheets[sheetName];
                        }
                    }
                    
                    showFileInfo();
                    document.getElementById('searchBtn').disabled = false;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    loadDateInfo.textContent = `–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - ${cachedData.loadTimestamp}`;
                    loadDateInfo.style.display = 'block';
                    document.getElementById('refreshDataBtn').style.display = 'inline-block';
                    document.getElementById('loading').classList.add('completed');
                    updateProgress(100, '–û—Å—Ç–∞–ª–æ—Å—å 0%');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —Å —Å–µ—Ä–≤–µ—Ä–∞ (–¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
                updateProgress(10);
                const response = await fetch(DATA_FILE_URL, {
                    cache: 'no-cache'
                });
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${response.status} ${response.statusText}`);
                }
                
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
                const contentLength = response.headers.get('content-length');
                let arrayBuffer;
                
                if (contentLength) {
                    const total = parseInt(contentLength, 10);
                    const reader = response.body.getReader();
                    const chunks = [];
                    let receivedLength = 0;
                    
                    while (true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        
                        chunks.push(value);
                        receivedLength += value.length;
                        // –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 10% –¥–æ 80% –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                        const percent = Math.min(80, 10 + (receivedLength / total) * 70);
                        updateProgress(percent);
                    }
                    
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞–Ω–∫–∏
                    const allChunks = new Uint8Array(receivedLength);
                    let position = 0;
                    for (const chunk of chunks) {
                        allChunks.set(chunk, position);
                        position += chunk.length;
                    }
                    arrayBuffer = allChunks.buffer;
                } else {
                    // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
                    updateProgress(20);
                    arrayBuffer = await response.arrayBuffer();
                    updateProgress(80);
                }
                
                const data = new Uint8Array(arrayBuffer);
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø—Ü–∏–∏
                updateProgress(90);
                workbook = XLSX.read(data, { 
                    type: 'array',
                    cellStyles: true,  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ª–∏–≤–∫–∏
                    dense: false      // –ò—Å–ø–æ–ª—å–∑—É–µ–º sparse –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
                });
                
                // –ò—â–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —á–∞—è –∏ –∫–æ—Ñ–µ
                updateProgress(92);
                const teaSheetName = 'MML —á–∞–π –±–µ–∑ –ü–ö';
                const coffeeSheetName = 'MML –∫–æ—Ñ–µ';
                let teaSheet = null;
                let coffeeSheet = null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ª–∏—Å—Ç—ã
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    if (sheetName === teaSheetName || sheetName.includes('MML —á–∞–π –±–µ–∑ –ü–ö')) {
                        teaSheet = workbook.Sheets[sheetName];
                        console.log('–ù–∞–π–¥–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –ß–ê–ô:', sheetName);
                    }
                    if (sheetName === coffeeSheetName || sheetName.includes('MML –∫–æ—Ñ–µ')) {
                        coffeeSheet = workbook.Sheets[sheetName];
                        console.log('–ù–∞–π–¥–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –ö–û–§–ï:', sheetName);
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤–∫–ª–∞–¥–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
                if (!teaSheet) {
                    console.warn(`–í–∫–ª–∞–¥–∫–∞ "${teaSheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
                }
                if (!coffeeSheet) {
                    console.warn(`–í–∫–ª–∞–¥–∫–∞ "${coffeeSheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—é
                if (teaSheet) {
                    currentCategory = 'tea';
                    await processSheetData(teaSheet, updateProgress, 94, 97);
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ—Ñ–µ
                if (coffeeSheet) {
                    currentCategory = 'coffee';
                    await processSheetData(coffeeSheet, updateProgress, 97, 99);
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —á–∞—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                currentCategory = 'tea';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
                saveToCache(arrayBuffer);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                showFileInfo();
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞
                document.getElementById('searchBtn').disabled = false;
                
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        const loadTimestamp = new Date().toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        loadDateInfo.textContent = `–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - ${loadTimestamp}`;
                        loadDateInfo.style.display = 'block';
                        document.getElementById('refreshDataBtn').style.display = 'inline-block';
                        document.getElementById('loading').classList.add('completed');
                
                // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                updateProgress(100, '–û—Å—Ç–∞–ª–æ—Å—å 0%');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
                updateProgress(0, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                document.getElementById('loading').style.display = 'none';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('refreshDataBtn').addEventListener('click', function() {
            // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_DATE_KEY);
            localStorage.removeItem(CACHE_FILE_KEY);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –¥–∞—Ç—É
            this.style.display = 'none';
            document.getElementById('loadDateInfo').style.display = 'none';
            document.getElementById('loading').classList.remove('completed');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadFileFromServer();
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadFileFromServer();
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞ (—á–∞–π –∏–ª–∏ –∫–æ—Ñ–µ)
        async function processSheetData(sheet, updateProgress, startProgress, endProgress) {
            updateProgress(startProgress);
            const sheetData = XLSX.utils.sheet_to_json(sheet, { 
                header: 1,
                raw: false,
                defval: ''
            });
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (—Å—Ç—Ä–æ–∫–∞ 4, –∏–Ω–¥–µ–∫—Å 3)
            if (sheetData.length >= 4) {
                const headers = sheetData[3]; // –°—Ç—Ä–æ–∫–∞ 4 (–∏–Ω–¥–µ–∫—Å 3)
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ "–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç SDO"
                const sdoIndex = findColumnIndex(['–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç SDO'], headers);
                
                if (sdoIndex !== -1) {
                    const skuStartIndex = sdoIndex + 1;
                    
                    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
                    const dataRows = [];
                    for (let i = 4; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (row && row.length > 0 && row.some(cell => cell !== '')) {
                            dataRows.push(row);
                        }
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    setActiveData(sheet, headers, dataRows, skuStartIndex);
                    
                    console.log(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${currentCategory.toUpperCase()}, –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${dataRows.length}, SKU –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –∫–æ–ª–æ–Ω–∫–∏: ${skuStartIndex}`);
                } else {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–ª–æ–Ω–∫—É "–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç SDO" –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${currentCategory}`);
                }
            }
            
            updateProgress(endProgress);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –∫–æ–ª–æ–Ω–∫–∏ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        function findColumnIndex(searchTerms, headersArray = null) {
            const activeHeaders = headersArray || getActiveData().headers;
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –∫—ç—à–∞ (–≤–∫–ª—é—á–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏)
            const cacheKey = `${currentCategory}|${searchTerms.join('|')}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (columnIndexCache.has(cacheKey)) {
                return columnIndexCache.get(cacheKey);
            }
            
            // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É
            for (let i = 0; i < activeHeaders.length; i++) {
                let header = activeHeaders[i] ? activeHeaders[i].toString().trim() : '';
                // –£–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
                header = header.replace(/<br\s*\/?>/gi, ' ').replace(/\s+/g, ' ').trim();
                
                for (const term of searchTerms) {
                    // –¢–∞–∫–∂–µ —É–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏ –∏–∑ –∏—Å–∫–æ–º–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞
                    const cleanTerm = term.replace(/<br\s*\/?>/gi, ' ').replace(/\s+/g, ' ').trim();
                    if (header.includes(cleanTerm) || cleanTerm.includes(header)) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                        columnIndexCache.set(cacheKey, i);
                        return i;
                    }
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º -1 –≤ –∫—ç—à, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏
            columnIndexCache.set(cacheKey, -1);
            return -1;
        }

        // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –¢–¢
        document.getElementById('searchBtn').addEventListener('click', searchByTT);
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(cursorPosition, cursorPosition);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByTT();
            }
        });

        function searchByTT() {
            const searchCode = document.getElementById('searchInput').value.trim();
            if (!searchCode) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¢–¢ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }

            if (!workbook) {
                showError('–§–∞–π–ª –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            const { headers, dataRows } = getActiveData();

            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ "–ö–æ–¥ –¢–¢"
            const ttCodeIndex = findColumnIndex(['–ö–æ–¥ –¢–¢'], headers);
            if (ttCodeIndex === -1) {
                showError('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ "–ö–æ–¥ –¢–¢" –≤ —Ñ–∞–π–ª–µ');
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º –∫–æ–¥–æ–º –¢–¢
            let foundRowIndex = -1;
            currentRowData = null;
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                if (row[ttCodeIndex] && row[ttCodeIndex].toString().trim() === searchCode) {
                    foundRowIndex = i;
                    currentRowData = row;
                    break;
                }
            }

            if (foundRowIndex === -1 || !currentRowData) {
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            setTimeout(() => {
                displayResults(foundRowIndex);
                document.getElementById('loading').style.display = 'none';
            }, 100);
        }

        function displayResults(rowIndex) {
            document.getElementById('noResults').style.display = 'none';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–µ
            displayTTInfo();
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ SKU
            collectSkuData(rowIndex);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
            applyFilter(currentFilter);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            document.getElementById('resultsSection').style.display = 'block';
        }

        function displayTTInfo() {
            const ttInfoContent = document.getElementById('ttInfoContent');
            let html = '';
            const infoColumns = getInfoColumns(); // –ü–æ–ª—É—á–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏
            
            infoColumns.forEach(col => {
                const index = findColumnIndex(col.search);
                let value = '‚Äî';
                if (index !== -1 && currentRowData && currentRowData[index] !== undefined) {
                    value = currentRowData[index].toString().trim();
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                    if (col.key === 'factPercent') {
                        // –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫ $ –≤ –Ω–∞—á–∞–ª–µ –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (value && value !== '‚Äî' && value.startsWith('$')) {
                            value = value.substring(1).trim();
                        }
                        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç %, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º %
                        if (value && value !== '‚Äî' && !value.includes('%')) {
                            // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ –∏ –¥–æ–±–∞–≤–∏—Ç—å %
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                value = numValue + '%';
                            } else {
                                value = value + '%';
                            }
                        }
                    }
                }
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ª–∞–¥–∫–∏
                // if (col.key === 'ttChannel' || col.key === 'factTeaQty' || col.key === 'completion' || col.key === 'factTeaPercent') {
                //     console.log(`–ö–æ–ª–æ–Ω–∫–∞ "${col.display}":`, { searchTerms: col.search, foundIndex: index, value: value });
                // }
                
                html += `
                    <div class="info-item">
                        <span class="info-label">${col.display}:</span>
                        <span class="info-value">${value}</span>
                    </div>
                `;
            });
            
            ttInfoContent.innerHTML = html;
        }

        function collectSkuData(rowIndex) {
            allSkuData = [];
            
            const { worksheet, headers, dataRows, skuStartIndex } = getActiveData();
            
            if (skuStartIndex === null || !currentRowData) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫ –∏–∑ worksheet
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            // rowIndex - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ dataRows (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)
            // dataRows –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 5-–π —Å—Ç—Ä–æ–∫–∏ Excel (–∏–Ω–¥–µ–∫—Å 4 –≤ sheetData, –Ω–æ —Å—Ç—Ä–æ–∫–∞ 5 –≤ Excel)
            // –ü–æ—ç—Ç–æ–º—É –¥–ª—è encode_cell (–∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 0-based –∏–Ω–¥–µ–∫—Å—ã) –Ω—É–∂–Ω–æ: rowIndex + 4
            const excelRowForEncode = rowIndex + 4;
            
            for (let col = skuStartIndex; col < headers.length; col++) {
                const skuName = headers[col] ? headers[col].toString().trim() : '';
                if (!skuName) continue;
                
                const cellValue = currentRowData[col] ? currentRowData[col].toString().trim() : '';
                const hasPlus = cellValue.includes('+');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –õ–Æ–ë–û–ô –∑–∞–ª–∏–≤–∫–∏ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ü–≤–µ—Ç–∞)
                let hasFill = false;
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å —è—á–µ–π–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel (–Ω–∞–ø—Ä–∏–º–µ—Ä, "A5")
                // encode_cell –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 0-based –∏–Ω–¥–µ–∫—Å—ã: r=0 —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 –≤ Excel
                const cellAddress = XLSX.utils.encode_cell({r: excelRowForEncode, c: col});
                const cell = worksheet[cellAddress];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–ª–∏–≤–∫–∏ –≤ —è—á–µ–π–∫–µ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                if (cell && cell.s) {
                    const style = cell.s;
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç fill (–¥–∞–∂–µ –ø—É—Å—Ç–æ–π), —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∑–∞–ª–∏–≤–∫–∞ –µ—Å—Ç—å
                    // –í Excel –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –∑–∞–ª–∏—Ç–∞, –æ–±—ä–µ–∫—Ç fill –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å—Ç–∏–ª—è—Ö
                    if (style.fill) {
                        hasFill = true;
                    }
                    
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–∏–ª—è
                    if (!hasFill && (style.bg || style.bgColor || style.backgroundColor)) {
                        hasFill = true;
                    }
                }
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ª–∞–¥–∫–∏
                // if (cell && cell.s && cell.s.fill) {
                //     console.log(`–Ø—á–µ–π–∫–∞ ${cellAddress} (${skuName}):`, { hasFill, value: cellValue });
                // }
                
                allSkuData.push({
                    name: skuName,
                    value: cellValue,
                    hasPlus: hasPlus,
                    hasFill: hasFill,
                    colIndex: col
                });
            }
        }

        function applyFilter(filterType) {
            currentFilter = filterType;
            const skuTableBody = document.getElementById('skuTableBody');
            skuTableBody.innerHTML = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filterType) {
                    btn.classList.add('active');
                }
            });
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            let filteredData = allSkuData;
            let filterText = '';
            
            switch(filterType) {
                case 'mml':
                    filteredData = allSkuData.filter(sku => sku.hasFill);
                    filterText = '–ü–ª–∞–Ω MML';
                    break;
                case 'plus':
                    filteredData = allSkuData.filter(sku => sku.hasPlus);
                    filterText = '–ü—Ä–æ–∫—É–ø–ª–µ–Ω–Ω—ã–µ MML';
                    break;
                default:
                    filteredData = allSkuData.filter(sku => sku.hasFill);
                    filterText = '–ü–ª–∞–Ω MML';
                    break;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            filteredData.forEach(sku => {
                const row = document.createElement('tr');
                
                let fillStatus = '–ù–µ –ø–ª–∞–Ω–æ–≤—ã–π MML';
                let fillStatusClass = 'status-no-fill';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø—É—Å—Ç–æ–µ –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫—Ä–∞—Å–Ω—ã–π –º–∏–Ω—É—Å)
                const isEmptyValue = !sku.value || sku.value.trim() === '';
                
                if (sku.hasFill) {
                    fillStatus = '–ü–ª–∞–Ω–æ–≤—ã–π MML';
                    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫—Ä–∞—Å–Ω—ã–π –º–∏–Ω—É—Å), –¥–µ–ª–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫—Ä–∞—Å–Ω—ã–º
                    if (isEmptyValue && !sku.hasPlus) {
                        fillStatusClass = 'status-no-fill';
                    } else {
                        fillStatusClass = 'status-green-fill';
                    }
                }
                
                let valueText = sku.value || '';
                if (sku.hasPlus) {
                    valueText = '<span style="color: #28a745; font-weight: bold; font-size: 1.2em;">+</span>';
                } else if (!valueText || valueText.trim() === '') {
                    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π –º–∏–Ω—É—Å
                    valueText = '<span style="color: #dc3545; font-weight: bold; font-size: 1.2em;">‚àí</span>';
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ SKU –≤ Title Case
                const formattedSkuName = toTitleCase(sku.name);
                
                row.innerHTML = `
                    <td class="sku-name">${formattedSkuName}</td>
                    <td>
                        <span class="sku-status ${fillStatusClass}">
                            <span class="status-icon"></span>
                            ${fillStatus}
                        </span>
                    </td>
                    <td>${valueText}</td>
                `;
                skuTableBody.appendChild(row);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('resultsCount').textContent = `${filteredData.length} SKU`;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterType = this.dataset.filter;
                applyFilter(filterType);
            });
        });

        function showFileInfo() {
            const { worksheet } = getActiveData();
            if (!worksheet) return;
            
            console.log('Worksheet keys:', Object.keys(worksheet).slice(0, 10));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —è—á–µ–µ–∫ —Å—Ç–∏–ª–∏
            for (let key in worksheet) {
                if (key.startsWith('!')) continue;
                const cell = worksheet[key];
                if (cell && cell.s) {
                    console.log('–Ø—á–µ–π–∫–∞ —Å —Å—Ç–∏–ª—è–º–∏:', key, cell);
                    break;
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ß–ê–ô/–ö–û–§–ï) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('category-tab')) {
                const category = e.target.getAttribute('data-category');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                currentCategory = category;
                
                // –û—á–∏—â–∞–µ–º –∫—ç—à –∏–Ω–¥–µ–∫—Å–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
                columnIndexCache.clear();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (currentRowData) {
                    displayTTInfo();
                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const { headers, dataRows } = getActiveData();
                    const ttCodeIndex = findColumnIndex(['–ö–æ–¥ –¢–¢'], headers);
                    if (ttCodeIndex !== -1) {
                        const searchCode = document.getElementById('searchInput').value.trim();
                        let foundRowIndex = -1;
                        for (let i = 0; i < dataRows.length; i++) {
                            const row = dataRows[i];
                            if (row[ttCodeIndex] && row[ttCodeIndex].toString().trim() === searchCode) {
                                foundRowIndex = i;
                                currentRowData = row;
                                break;
                            }
                        }
                        if (foundRowIndex !== -1) {
                            collectSkuData(foundRowIndex);
                            applyFilter(currentFilter);
                        }
                    }
                }
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
